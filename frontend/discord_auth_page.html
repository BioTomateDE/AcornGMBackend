<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AcornGM - Login</title>
    <link rel="stylesheet" href="./styles.css">
</head>
<body>
<h1>AcornGM</h1>
<h2>Finishing Login Process...</h2>
<p><strong>Login Status:</strong> <span id="login-status">Waiting for script...</span></p>
<button hidden="hidden" id="register-button" onclick="doRegister()">Login</button>
<script>
    function checkString(string) {
        return typeof string === 'string' && string.length >= 0
    }
    function doRegister() {
        if (!checkString(discordRefreshToken) || !checkString(discordUserId)) return;
        window.location.replace("/register?" + new URLSearchParams( {discordRefreshToken, discordUserId} ));
    }

    let discordRefreshToken = null;
    let discordUserId = null;

    window.onload = async () => {
        const loginStatus = document.getElementById("login-status");
        const registerButton = document.getElementById("register-button");

        const urlParams = new URLSearchParams(window.location.search);
        const discordCode = urlParams.get('code');
        if (!checkString(discordCode)) {
            loginStatus.innerText = "Discord authorization code missing! This shouldn't happen if you were redirected by Discord.";
            return;
        }

        const query = new URLSearchParams( {discord_code: discordCode} );
        const url = "/api/discord_auth?" + query;
        let response;
        try {
            response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
        } catch (error) {
            loginStatus.innerText = `Error: Could not send request to AcornGM Server: ${error}`;
            console.error(`Fetching /api/discord_auth failed: ${error}`);
            return;
        }

        console.log(`Sent request to ${url}`);

        if (response.status === 404) {
            loginStatus.innerText = `Error: AcornGM Server returned 404 - Not Found`;
            console.error(`AcornGM responded with 404 - Not Found; Response Text: ${await response.text()}`);
            return;
        }

        let respJson;
        try {
            respJson = await response.json();
        } catch (error) {
            loginStatus.innerText = `Error: Could get JSON from response: ${error}`;
            console.error(`Could not get JSON from response: ${error}`);
            console.warn(`Response Text: ${await response.text()}`);
            return;
        }

        if (response.status === 500) {
            const errorMessage = respJson['error'];
            loginStatus.innerText = `Internal Error: ${errorMessage}\n\nPlease contact BioTomateDE about this.`;
            console.error(`AcornGM responded with 500 - Internal Server Error; Error Message: ${errorMessage}`);
            return;
        }

        if (!response.ok) {
            loginStatus.innerText = `Error: AcornGM Server responded with HTTP Status Code ${response.status} - ${response.statusText}: ${respJson['error']}`;
            console.error(`AcornGM responded with HTTP ${response.status} - ${response.statusText}: ${respJson}`);
            return;
        }

        const isNewUser = respJson['register'];    // bool
        if (isNewUser) {
            registerButton.hidden = false;
        } else {
            discordRefreshToken = respJson['discordRefreshToken'];
            discordUserId = respJson['discordUserId'];
            if (!checkString(discordRefreshToken) || !checkString(discordUserId)) {
                console.error(`Response is missing discord refresh token or user ID: ${respJson}`);
                loginStatus.innerText = `Error: Invalid or empty response by AcornGM Server`;
                return;
            }
        }

        loginStatus.innerText = "Success";
        console.log("Success");
    }
</script>
</body>
</html>
