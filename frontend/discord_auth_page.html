<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AcornGM- Login</title>
    <link rel="stylesheet" href="./styles.css">
</head>
<body>
<h1>AcornGM</h1>
<h2>Finishing Login Process...</h2>
<p><strong>Login Status:</strong> <span id="login-status">Waiting for script...</span></p>
<button hidden="hidden" id="register-button" onclick="doRegister()">Login</button>
<script>
    function checkString(string) {
        return typeof string === 'string' && string.length >= 0
    }
    function doRegister() {
        if (!checkString(discordRefreshToken) || !checkString(discordUserId)) return;
        window.location.replace(new URL("register", ACORNGM_API_URL) + new URLSearchParams( {discordRefreshToken, discordUserId} ));
    }

    // const ACORNGM_API_URL = "https://acorngm.onrender.com";
    const ACORNGM_API_URL = "http://localhost:8080";

    let discordRefreshToken = null;
    let discordUserId = null;

    window.onload = async () => {
        const loginStatus = document.getElementById("login-status");
        const registerButton = document.getElementById("register-button");

        const urlParams = new URLSearchParams(window.location.search);
        const discordCode = urlParams.get('code');
        if (!checkString(discordCode)) {
            loginStatus.innerText = "Discord authorization code missing! This shouldn't happen if you were redirected by Discord.";
            return;
        }

        const query = new URLSearchParams( {discord_code: discordCode} );
        const response = await fetch(new URL("/api/discord_auth" + query, ACORNGM_API_URL), {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        const resp = await response.json();     // may fail

        if (!response.ok) {
            console.error(`HTTP ${response.status} - ${response.statusText}: ${resp}`);
            loginStatus.innerText = `Error: AcornGM Server responded with HTTP Status Code ${response.status} - ${response.statusText}: ${resp}`;
            return;
        }

        const isNewUser = resp['register'];    // bool
        if (isNewUser) {
            registerButton.hidden = false;
        } else {
            discordRefreshToken = resp['discordRefreshToken'];
            discordUserId = resp['discordUserId'];
            if (!checkString(discordRefreshToken) || !checkString(discordUserId)) {
                console.error(`Response is missing discord refresh token or user ID: ${resp}`);
                loginStatus.innerText = `Error: Invalid or empty response by AcornGM Server`;
                return;
            }
        }
        loginStatus.innerText = "Success";
    }
</script>
</body>
</html>
