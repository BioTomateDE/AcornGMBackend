<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AcornGM- Login</title>
    <link rel="stylesheet" href="./styles.css">
</head>
<body>
<h1>AcornGM</h1>
<h2>Finishing Login Process...</h2>
<p><strong>Login Status:</strong> <span id="login-status">Waiting for script...</span></p>
<button hidden="hidden" id="login-button" onclick="doLogin()">Login</button>
<button hidden="hidden" id="register-button" onclick="doRegister()">Login</button>
<script>
    function checkString(string) {
        return typeof string === 'string' && string.length >= 0
    }

    // const ACORNGM_API_URL = "https://acorngm.onrender.com";
    const ACORNGM_API_URL = "http://localhost:3000";
    window.onload = async () => {
        const loginStatus = document.getElementById("login-status");
        const loginButton = document.getElementById("login-button");
        const registerButton = document.getElementById("register-button");

        const urlParams = new URLSearchParams(window.location.search);
        const discordCode = urlParams.get('code');
        if (!checkString(discordCode)) {
            loginStatus.innerText = "Discord authorization code missing! This shouldn't happen if you were redirected by Discord.";
            return;
        }

        const query = new URLSearchParams({discordCode: discordCode});
        const response = await fetch(new URL("discord_auth" + query, ACORNGM_API_URL), {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        const resp = await response.json();     // may fail

        if (!response.ok) {
            console.error(`HTTP ${response.status} - ${response.statusText}: ${resp}`);
            loginStatus.innerText = `Error: AcornGM Server responded with HTTP Status Code ${response.status} - ${response.statusText}: ${resp}`;
            return;
        }

        const discordRefreshToken = resp['discordRefreshToken'];
        if (!checkString(discordRefreshToken)) {
            console.error(`Response is missing discord refresh token: ${resp}`);
            loginStatus.innerText = `Error: Invalid or empty response by AcornGM Server`;
            return;
        }

        const discordUserId = resp['discordUserId'];
        // if user id exists, then login. else, register.
        let isNewUser = !checkString(discordUserId);
        if (isNewUser) {
            registerButton.hidden = false;
        } else {
            loginButton.hidden = false;
            localStorage.setItem("discordUserId", discordUserId);
        }

        localStorage.setItem("discordRefreshToken", discordRefreshToken);
        loginStatus.innerText = "Success";

        return await response.json();
    }
</script>
</body>
</html>
